name: Cherry pick from main to release branches

on:
  pull_request_target:
    branches:
      - main
    types: ["closed"]

permissions: {}

jobs:
  find_branches:
    runs-on: ubuntu-latest
    name: Find branches to check-pick
    permissions:
      pull-requests: write
      contents: write
    if: ${{ github.event.pull_request.merged == true }}
    outputs:
      CHERRY_PICK_BRANCHES: ${{ steps.extract_labels.outputs.CHERRY_PICK_BRANCHES }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR labels
        id: get_labels
        uses: actions/github-script@60a0d83039c74a4aee543508d2ffcb1c3799cdea
        with:
          script: |
            const labels = await github.rest.issues.listLabelsOnIssue({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
            });

            // Output the labels as a comma-separated list
            const labelNames = labels.data.map(label => label.name).join(',');
            console.log(`PR labels: ${labelNames}`);
            return labelNames;

      - name: Extract cherry-pick labels
        id: extract_labels
        run: |
          cherry_pick_branches=$(for label in "${{ steps.get_labels.outputs.result }}"; do
            if [[ $label == cherry-pick/* ]]; then
              branch=${label#cherry-pick/}
              echo $branch
            fi
          done | jq -R -s -c 'split("\n")[:-1]')
          echo $cherry_pick_branches
          echo "CHERRY_PICK_BRANCHES=$cherry_pick_branches" >> $GITHUB_OUTPUT

  cherry_pick:
    needs: find_branches
    runs-on: ubuntu-latest
    name: Create cherry-pick pull request
    permissions:
      pull-requests: write
      contents: write
    strategy:
      matrix:
        branch: ${{ fromJson(needs.find_branches.outputs.CHERRY_PICK_BRANCHES) }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Cherry pick to branch ${{ matrix.branch }}
        uses: carloscastrojumo/github-cherry-pick-action@v1.0.10
        with:
          branch: ${{ matrix.branch }}
          body: "Cherry-pick of PR #${{ github.event.pull_request.number }} to branch ${{ matrix.branch }}."
          cherry-pick-branch: ${{ format('cherry-pick-{0}-{1}', github.event.number, matrix.branch) }}
          title: "[${{ matrix.branch }}] Cherry-pick: ${{ github.event.pull_request.title }}"
          labels: |
            cherry-pick
